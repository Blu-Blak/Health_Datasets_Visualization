<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medical Domain Visual Analytics Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  
  body {
    background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
    color: #fff;
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }

  /* Header Section */
  .header {
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding: 30px 40px;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  .header h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .header p {
    margin: 10px 0 0;
    color: rgba(255,255,255,0.6);
    font-size: 14px;
    font-weight: 300;
  }

  /* Stats Bar */
  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    padding: 25px 40px;
    background: rgba(255,255,255,0.02);
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #60a5fa;
  }

  .stat-label {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  /* Main Content */
  .dashboard {
    padding: 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Chart Cards */
  .chart-card {
    background: linear-gradient(145deg, rgba(30, 30, 50, 0.8) 0%, rgba(20, 20, 35, 0.9) 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 40px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 
      0 20px 40px rgba(0,0,0,0.3),
      0 0 80px rgba(99, 102, 241, 0.05);
    position: relative;
    overflow: hidden;
  }

  .chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
  }

  .chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .chart-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chart-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .chart-icon.gender { background: linear-gradient(135deg, #fb8072, #80b1d3); }
  .chart-icon.age { background: linear-gradient(135deg, #5dade2, #e74c3c); }
  .chart-icon.network { background: linear-gradient(135deg, #8dd3c7, #bebada); }

  h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #fff;
  }

  .chart-subtitle {
    color: rgba(255,255,255,0.5);
    font-size: 13px;
    margin-top: 4px;
  }

  .chart-badge {
    background: rgba(99, 102, 241, 0.2);
    color: #a5b4fc;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  svg {
    display: block;
    margin: 0 auto;
  }

  .axis path, .axis line {
    stroke: rgba(255,255,255,0.15);
  }
  .axis text {
    fill: rgba(255,255,255,0.7);
    font-size: 12px;
    font-family: 'Inter', sans-serif;
  }
  .grid line {
    stroke: rgba(255,255,255,0.06);
    stroke-dasharray: 4,4;
  }
  .legend {
    font-size: 12px;
  }
  .legend rect {
    stroke: none;
    rx: 3;
  }
  .bar-label {
    fill: #fff;
    font-size: 11px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
  }
  .tooltip {
    position: absolute;
    background: rgba(15, 15, 30, 0.95);
    color: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 13px;
    pointer-events: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
  }
  .node-label {
    fill: #fff;
    font-size: 11px;
    font-weight: 500;
    pointer-events: none;
    text-anchor: middle;
    font-family: 'Inter', sans-serif;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 30px;
    color: rgba(255,255,255,0.3);
    font-size: 13px;
    border-top: 1px solid rgba(255,255,255,0.05);
  }

  .footer a {
    color: #60a5fa;
    text-decoration: none;
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chart-card {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .chart-card:nth-child(1) { animation-delay: 0.1s; }
  .chart-card:nth-child(2) { animation-delay: 0.2s; }
  .chart-card:nth-child(3) { animation-delay: 0.3s; }

  /* Glow effects on hover */
  .chart-card:hover {
    border-color: rgba(99, 102, 241, 0.3);
    box-shadow: 
      0 20px 40px rgba(0,0,0,0.3),
      0 0 100px rgba(99, 102, 241, 0.1);
    transition: all 0.3s ease;
  }
</style>
</head>

<body>

<!-- Header -->
<div class="header">
  <h1>üè• Medical Domain Visual Analytics</h1>
  <p>Interactive visualization of health data patterns and medical knowledge relationships</p>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
  <div class="stat-item">
    <div class="stat-value">10+</div>
    <div class="stat-label">Disease Categories</div>
  </div>
  <div class="stat-item">
    <div class="stat-value">1000+</div>
    <div class="stat-label">Medical Records</div>
  </div>
  <div class="stat-item">
    <div class="stat-value">4</div>
    <div class="stat-label">Age Demographics</div>
  </div>
  <div class="stat-item">
    <div class="stat-value">25+</div>
    <div class="stat-label">Network Entities</div>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard">

  <!-- Gender Chart Card -->
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">
        <div class="chart-icon gender">üë•</div>
        <div>
          <h2>Gender Comparison by Disease Category</h2>
          <div class="chart-subtitle">Distribution of medical conditions across genders</div>
        </div>
      </div>
      <div class="chart-badge">Grouped Bar Chart</div>
    </div>
    <svg id="genderChart" width="1100" height="480"></svg>
  </div>

  <!-- Age Chart Card -->
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">
        <div class="chart-icon age">üìä</div>
        <div>
          <h2>Disease Distribution by Age Group</h2>
          <div class="chart-subtitle">Click age groups to compare side-by-side (Butterfly Chart)</div>
        </div>
      </div>
      <div class="chart-badge">Interactive Comparison</div>
    </div>
    <svg id="ageChart" width="1100" height="580"></svg>
  </div>

  <!-- Network Chart Card -->
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">
        <div class="chart-icon network">üîó</div>
        <div>
          <h2>Medical Knowledge Network</h2>
          <div class="chart-subtitle">Interactive relationships between symptoms, diseases, and treatments</div>
        </div>
      </div>
      <div class="chart-badge">Force-Directed Graph</div>
    </div>
    <svg id="network" width="1000" height="700"></svg>
  </div>

</div>

<!-- Footer -->
<div class="footer">
  <p>Built with using D3.js ‚Ä¢ Medical Data Analytics Dashboard</p>
</div>

<script>
/* ============================================================
   1. GENDER √ó DISEASE (HORIZONTAL GROUPED BAR - Enhanced Style)
============================================================ */
d3.json("data/gender_disease.json").then(data => {
  const svg = d3.select("#genderChart"),
        margin = {top: 20, right: 140, bottom: 50, left: 160},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

  const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

  const genders = ["Female", "Male"];
  const diseases = data.map(d => d.disease);

  // Enhanced color scheme with gradients
  const color = d3.scaleOrdinal()
                  .domain(genders)
                  .range(["#f472b6", "#60a5fa"]);

  const y0 = d3.scaleBand()
               .domain(diseases)
               .range([0, height])
               .padding(0.3);

  const y1 = d3.scaleBand()
               .domain(genders)
               .range([0, y0.bandwidth()])
               .padding(0.1);

  const maxVal = d3.max(data, d => Math.max(d.Male || 0, d.Female || 0));
  const x = d3.scaleLinear()
              .domain([0, maxVal * 1.2])
              .range([0, width]);

  // Add vertical grid lines
  g.append("g")
   .attr("class", "grid")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(x)
     .tickSize(-height)
     .tickFormat("")
   );

  // Y Axis
  g.append("g")
   .attr("class", "axis")
   .call(d3.axisLeft(y0).tickSize(0))
   .select(".domain").remove();

  // X Axis
  g.append("g")
   .attr("class", "axis")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(x).ticks(8));

  // X Axis Label
  g.append("text")
   .attr("x", width / 2)
   .attr("y", height + 40)
   .attr("fill", "rgba(255,255,255,0.7)")
   .attr("text-anchor", "middle")
   .attr("font-size", "13px")
   .text("Number of Prompts");

  // Draw bars with rounded corners
  const diseaseGroups = g.selectAll(".disease-group")
    .data(data)
    .enter().append("g")
    .attr("class", "disease-group")
    .attr("transform", d => `translate(0,${y0(d.disease)})`);

  diseaseGroups.selectAll("rect")
    .data(d => genders.map(gender => ({ gender, value: d[gender] || 0 })))
    .enter().append("rect")
    .attr("y", d => y1(d.gender))
    .attr("height", y1.bandwidth())
    .attr("x", 0)
    .attr("width", 0)
    .attr("fill", d => color(d.gender))
    .attr("rx", 4)
    .attr("ry", 4)
    .style("filter", "drop-shadow(0 2px 4px rgba(0,0,0,0.2))")
    .transition()
    .duration(800)
    .delay((d, i) => i * 50)
    .attr("width", d => x(d.value));

  // Add value labels
  diseaseGroups.selectAll(".bar-label")
    .data(d => genders.map(gender => ({ gender, value: d[gender] || 0 })))
    .enter().append("text")
    .attr("class", "bar-label")
    .attr("x", d => x(d.value) + 8)
    .attr("y", d => y1(d.gender) + y1.bandwidth() / 2)
    .attr("dy", "0.35em")
    .attr("opacity", 0)
    .text(d => d.value)
    .transition()
    .duration(800)
    .delay((d, i) => i * 50 + 400)
    .attr("opacity", 1);

  // Enhanced Legend
  const legend = svg.append("g")
    .attr("class", "legend")
    .attr("transform", `translate(${width + margin.left + 30}, ${margin.top + 40})`);

  legend.append("text")
    .attr("x", 0)
    .attr("y", -15)
    .attr("fill", "rgba(255,255,255,0.9)")
    .attr("font-weight", "600")
    .attr("font-size", "13px")
    .text("Gender");

  genders.forEach((gender, i) => {
    const row = legend.append("g")
      .attr("transform", `translate(0, ${i * 30})`);
    
    row.append("rect")
      .attr("width", 20)
      .attr("height", 20)
      .attr("fill", color(gender))
      .attr("rx", 4);
    
    row.append("text")
      .attr("x", 28)
      .attr("y", 15)
      .attr("fill", "rgba(255,255,255,0.8)")
      .attr("font-size", "13px")
      .text(gender);
  });
});

/* ============================================================
   2. AGE GROUP √ó DISEASE (DUAL MODE: Butterfly Compare + Stacked All)
============================================================ */
d3.json("data/age_disease.json").then(data => {
  const svg = d3.select("#ageChart"),
        margin = {top: 80, right: 200, bottom: 50, left: 160},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

  const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

  const ageGroups = ["Adult (41-65)", "Pediatric (0-18)", "Senior (65+)", "Young Adult (19-40)"];
  const diseases = data.map(d => d.disease);

  // Colors for age groups
  const color = d3.scaleOrdinal()
                  .domain(ageGroups)
                  .range(["#38bdf8", "#fbbf24", "#fb923c", "#f43f5e"]);

  // State
  let leftGroup = "Adult (41-65)";
  let rightGroup = "Young Adult (19-40)";
  let viewMode = "compare"; // "compare" or "stacked"

  const y = d3.scaleBand()
              .domain(diseases)
              .range([0, height])
              .padding(0.25);

  const maxVal = d3.max(data, d => 
    Math.max(...ageGroups.map(ag => d[ag] || 0))
  );

  const maxTotal = d3.max(data, d => 
    ageGroups.reduce((sum, ag) => sum + (d[ag] || 0), 0)
  );

  const centerX = width / 2;

  // Scales for butterfly mode
  const xLeft = d3.scaleLinear()
              .domain([0, maxVal * 1.2])
              .range([centerX - 10, 0]);

  const xRight = d3.scaleLinear()
              .domain([0, maxVal * 1.2])
              .range([centerX + 10, width]);

  // Scale for stacked mode
  const xStacked = d3.scaleLinear()
              .domain([0, maxTotal * 1.1])
              .range([0, width]);

  // Y Axis (Disease names on left - clearly visible)
  const yAxisGroup = g.append("g")
   .attr("class", "axis y-axis")
   .call(d3.axisLeft(y).tickSize(0));

  yAxisGroup.select(".domain").attr("stroke", "rgba(255,255,255,0.3)");

  yAxisGroup.selectAll("text")
    .attr("fill", "rgba(255,255,255,0.9)")
    .style("font-size", "12px")
    .style("font-weight", "500");

  // Center divider line (for butterfly mode)
  const centerLine = g.append("line")
    .attr("class", "center-line")
    .attr("x1", centerX)
    .attr("y1", -10)
    .attr("x2", centerX)
    .attr("y2", height + 10)
    .attr("stroke", "rgba(255,255,255,0.4)")
    .attr("stroke-width", 2)
    .attr("stroke-dasharray", "6,4");

  // X Axes container
  const xAxisLeft = g.append("g")
   .attr("class", "axis x-axis-left")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(xLeft).ticks(5));

  const xAxisRight = g.append("g")
   .attr("class", "axis x-axis-right")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(xRight).ticks(5));

  const xAxisStacked = g.append("g")
   .attr("class", "axis x-axis-stacked")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(xStacked).ticks(8))
   .style("opacity", 0);

  // X Axis Labels
  const leftLabel = g.append("text")
   .attr("x", centerX / 2)
   .attr("y", height + 40)
   .attr("fill", color(leftGroup))
   .attr("text-anchor", "middle")
   .attr("font-size", "13px")
   .attr("font-weight", "600")
   .attr("class", "left-label")
   .text(`‚Üê ${leftGroup}`);

  const rightLabel = g.append("text")
   .attr("x", centerX + (width - centerX) / 2)
   .attr("y", height + 40)
   .attr("fill", color(rightGroup))
   .attr("text-anchor", "middle")
   .attr("font-size", "13px")
   .attr("font-weight", "600")
   .attr("class", "right-label")
   .text(`${rightGroup} ‚Üí`);

  const stackedLabel = g.append("text")
   .attr("x", width / 2)
   .attr("y", height + 40)
   .attr("fill", "rgba(255,255,255,0.7)")
   .attr("text-anchor", "middle")
   .attr("font-size", "13px")
   .attr("class", "stacked-label")
   .text("Number of Mentions (Frequency)")
   .style("opacity", 0);

  // Create bar groups
  const barGroups = g.selectAll(".bar-group")
    .data(data)
    .enter().append("g")
    .attr("class", "bar-group")
    .attr("transform", d => `translate(0,${y(d.disease)})`);

  // Left bars (butterfly mode)
  barGroups.append("rect")
    .attr("class", "left-bar")
    .attr("x", d => xLeft(d[leftGroup] || 0))
    .attr("y", 0)
    .attr("width", d => centerX - 10 - xLeft(d[leftGroup] || 0))
    .attr("height", y.bandwidth())
    .attr("fill", color(leftGroup))
    .attr("rx", 4);

  // Right bars (butterfly mode)
  barGroups.append("rect")
    .attr("class", "right-bar")
    .attr("x", centerX + 10)
    .attr("y", 0)
    .attr("width", d => xRight(d[rightGroup] || 0) - centerX - 10)
    .attr("height", y.bandwidth())
    .attr("fill", color(rightGroup))
    .attr("rx", 4);

  // Stacked bars (hidden initially)
  ageGroups.forEach((ag, i) => {
    barGroups.append("rect")
      .attr("class", `stacked-bar stacked-bar-${i}`)
      .attr("x", d => {
        let offset = 0;
        for (let j = 0; j < i; j++) {
          offset += xStacked(d[ageGroups[j]] || 0);
        }
        return offset;
      })
      .attr("y", 0)
      .attr("width", d => xStacked(d[ag] || 0))
      .attr("height", y.bandwidth())
      .attr("fill", color(ag))
      .attr("rx", 2)
      .style("opacity", 0);

    // Labels inside each stacked segment
    barGroups.append("text")
      .attr("class", `bar-label stacked-segment-label stacked-label-${i}`)
      .attr("x", d => {
        let offset = 0;
        for (let j = 0; j < i; j++) {
          offset += xStacked(d[ageGroups[j]] || 0);
        }
        return offset + xStacked(d[ag] || 0) / 2;
      })
      .attr("y", y.bandwidth() / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-weight", "600")
      .attr("font-size", "10px")
      .text(d => (d[ag] || 0) > 0 ? (d[ag] || 0) : "")
      .style("opacity", 0);
  });

  // Total labels at the end of stacked bars (just the number)
  barGroups.append("text")
    .attr("class", "bar-label total-value")
    .attr("x", d => {
      const total = ageGroups.reduce((sum, ag) => sum + (d[ag] || 0), 0);
      return xStacked(total) + 8;
    })
    .attr("y", y.bandwidth() / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", "start")
    .attr("fill", "#fff")
    .attr("font-weight", "700")
    .attr("font-size", "12px")
    .text(d => ageGroups.reduce((sum, ag) => sum + (d[ag] || 0), 0))
    .style("opacity", 0);

  // Left value labels
  barGroups.append("text")
    .attr("class", "bar-label left-value")
    .attr("x", d => xLeft(d[leftGroup] || 0) - 6)
    .attr("y", y.bandwidth() / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", "end")
    .text(d => d[leftGroup] || 0);

  // Right value labels
  barGroups.append("text")
    .attr("class", "bar-label right-value")
    .attr("x", d => xRight(d[rightGroup] || 0) + 6)
    .attr("y", y.bandwidth() / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", "start")
    .text(d => d[rightGroup] || 0);

  // Function to switch to Compare mode
  function showCompareMode() {
    viewMode = "compare";
    
    // Show butterfly elements
    centerLine.transition().duration(400).style("opacity", 1);
    xAxisLeft.transition().duration(400).style("opacity", 1);
    xAxisRight.transition().duration(400).style("opacity", 1);
    leftLabel.transition().duration(400).style("opacity", 1);
    rightLabel.transition().duration(400).style("opacity", 1);
    
    // Hide stacked elements
    xAxisStacked.transition().duration(400).style("opacity", 0);
    stackedLabel.transition().duration(400).style("opacity", 0);
    
    // Show butterfly bars
    barGroups.selectAll(".left-bar")
      .transition().duration(500)
      .style("opacity", 1)
      .attr("x", d => xLeft(d[leftGroup] || 0))
      .attr("width", d => centerX - 10 - xLeft(d[leftGroup] || 0))
      .attr("fill", color(leftGroup));

    barGroups.selectAll(".right-bar")
      .transition().duration(500)
      .style("opacity", 1)
      .attr("width", d => xRight(d[rightGroup] || 0) - centerX - 10)
      .attr("fill", color(rightGroup));

    // Hide stacked bars
    barGroups.selectAll(".stacked-bar")
      .transition().duration(400)
      .style("opacity", 0);

    // Show value labels
    barGroups.selectAll(".left-value")
      .transition().duration(500)
      .style("opacity", 1)
      .attr("x", d => xLeft(d[leftGroup] || 0) - 6)
      .text(d => d[leftGroup] || 0);

    barGroups.selectAll(".right-value")
      .transition().duration(500)
      .style("opacity", 1)
      .attr("x", d => xRight(d[rightGroup] || 0) + 6)
      .text(d => d[rightGroup] || 0);

    // Hide stacked labels and totals
    barGroups.selectAll(".stacked-segment-label, .total-value")
      .transition().duration(400)
      .style("opacity", 0);

    // Update labels
    leftLabel.transition().duration(300)
      .attr("fill", color(leftGroup))
      .text(`‚Üê ${leftGroup}`);
    rightLabel.transition().duration(300)
      .attr("fill", color(rightGroup))
      .text(`${rightGroup} ‚Üí`);

    updateLegendState();
  }

  // Function to switch to Stacked mode
  function showStackedMode() {
    viewMode = "stacked";
    
    // Hide butterfly elements
    centerLine.transition().duration(400).style("opacity", 0);
    xAxisLeft.transition().duration(400).style("opacity", 0);
    xAxisRight.transition().duration(400).style("opacity", 0);
    leftLabel.transition().duration(400).style("opacity", 0);
    rightLabel.transition().duration(400).style("opacity", 0);
    
    // Show stacked elements
    xAxisStacked.transition().duration(400).style("opacity", 1);
    stackedLabel.transition().duration(400).style("opacity", 1);
    
    // Hide butterfly bars
    barGroups.selectAll(".left-bar")
      .transition().duration(400)
      .style("opacity", 0);

    barGroups.selectAll(".right-bar")
      .transition().duration(400)
      .style("opacity", 0);

    // Show stacked bars with proper positioning
    ageGroups.forEach((ag, i) => {
      barGroups.selectAll(`.stacked-bar-${i}`)
        .transition().duration(500).delay(i * 100)
        .style("opacity", 1)
        .attr("x", d => {
          let offset = 0;
          for (let j = 0; j < i; j++) {
            offset += xStacked(d[ageGroups[j]] || 0);
          }
          return offset;
        })
        .attr("width", d => xStacked(d[ag] || 0));
    });

    // Hide value labels for compare mode
    barGroups.selectAll(".left-value, .right-value")
      .transition().duration(400)
      .style("opacity", 0);

    // Show stacked segment labels (numbers inside each colored section)
    ageGroups.forEach((ag, i) => {
      barGroups.selectAll(`.stacked-label-${i}`)
        .transition().duration(500).delay(i * 100 + 200)
        .style("opacity", 1)
        .attr("x", d => {
          let offset = 0;
          for (let j = 0; j < i; j++) {
            offset += xStacked(d[ageGroups[j]] || 0);
          }
          return offset + xStacked(d[ag] || 0) / 2;
        });
    });

    // Show total at the end
    barGroups.selectAll(".total-value")
      .transition().duration(500).delay(500)
      .style("opacity", 1);

    updateLegendState();
  }

  function updateLegendState() {
    // Update legend selection indicators
    legendItems.select("rect")
      .attr("stroke", d => {
        if (viewMode === "stacked") return "transparent";
        return (d === leftGroup || d === rightGroup) ? "#fff" : "transparent";
      })
      .attr("stroke-width", d => {
        if (viewMode === "stacked") return 0;
        return (d === leftGroup || d === rightGroup) ? 2 : 0;
      });

    legendItems.select(".side-indicator")
      .text(d => {
        if (viewMode === "stacked") return "";
        return d === leftGroup ? "‚óÄ LEFT" : d === rightGroup ? "RIGHT ‚ñ∂" : "";
      });

    // Update mode buttons
    modeButtons.selectAll("rect")
      .attr("fill", (d, i) => {
        if (i === 0 && viewMode === "compare") return "rgba(99, 102, 241, 0.5)";
        if (i === 1 && viewMode === "stacked") return "rgba(99, 102, 241, 0.5)";
        return "rgba(255,255,255,0.1)";
      });
  }

  // MODE TOGGLE BUTTONS
  const modeButtons = svg.append("g")
    .attr("transform", `translate(${margin.left}, 25)`);

  modeButtons.append("text")
    .attr("x", 0)
    .attr("y", 0)
    .attr("fill", "rgba(255,255,255,0.7)")
    .attr("font-size", "12px")
    .attr("font-weight", "600")
    .text("View Mode:");

  // Compare button
  const compareBtn = modeButtons.append("g")
    .attr("transform", "translate(85, -12)")
    .style("cursor", "pointer")
    .on("click", showCompareMode);

  compareBtn.append("rect")
    .attr("width", 120)
    .attr("height", 28)
    .attr("rx", 14)
    .attr("fill", "rgba(99, 102, 241, 0.5)");

  compareBtn.append("text")
    .attr("x", 60)
    .attr("y", 18)
    .attr("text-anchor", "middle")
    .attr("fill", "#fff")
    .attr("font-size", "11px")
    .attr("font-weight", "500")
    .text("üîÑ Compare 2");

  // Stacked button
  const stackedBtn = modeButtons.append("g")
    .attr("transform", "translate(215, -12)")
    .style("cursor", "pointer")
    .on("click", showStackedMode);

  stackedBtn.append("rect")
    .attr("width", 120)
    .attr("height", 28)
    .attr("rx", 14)
    .attr("fill", "rgba(255,255,255,0.1)");

  stackedBtn.append("text")
    .attr("x", 60)
    .attr("y", 18)
    .attr("text-anchor", "middle")
    .attr("fill", "#fff")
    .attr("font-size", "11px")
    .attr("font-weight", "500")
    .text("üìä Show All 4");

  // Interactive Legend
  const legend = svg.append("g")
    .attr("class", "legend")
    .attr("transform", `translate(${width + margin.left + 20}, ${margin.top + 20})`);

  legend.append("rect")
    .attr("x", -15)
    .attr("y", -35)
    .attr("width", 175)
    .attr("height", ageGroups.length * 45 + 55)
    .attr("fill", "rgba(255,255,255,0.05)")
    .attr("rx", 10)
    .attr("stroke", "rgba(255,255,255,0.1)");

  legend.append("text")
    .attr("x", 0)
    .attr("y", -15)
    .attr("fill", "rgba(255,255,255,0.9)")
    .attr("font-weight", "600")
    .attr("font-size", "13px")
    .text("Age Demographics");

  legend.append("text")
    .attr("x", 0)
    .attr("y", 2)
    .attr("fill", "rgba(255,255,255,0.5)")
    .attr("font-size", "10px")
    .text("Click to select (Compare mode)");

  let clickCount = 0;

  const legendItems = legend.selectAll(".legend-item")
    .data(ageGroups)
    .enter().append("g")
    .attr("class", "legend-item")
    .attr("transform", (d, i) => `translate(0, ${i * 45 + 20})`)
    .style("cursor", "pointer")
    .on("click", function(event, d) {
      if (viewMode === "compare") {
        clickCount++;
        if (clickCount % 2 === 1) {
          leftGroup = d;
        } else {
          rightGroup = d;
        }
        showCompareMode();
      }
    })
    .on("mouseover", function() {
      d3.select(this).select("rect")
        .transition()
        .duration(150)
        .attr("transform", "scale(1.1)");
    })
    .on("mouseout", function() {
      d3.select(this).select("rect")
        .transition()
        .duration(150)
        .attr("transform", "scale(1)");
    });

  legendItems.append("rect")
    .attr("width", 24)
    .attr("height", 24)
    .attr("fill", d => color(d))
    .attr("rx", 6)
    .attr("stroke", d => (d === leftGroup || d === rightGroup) ? "#fff" : "transparent")
    .attr("stroke-width", d => (d === leftGroup || d === rightGroup) ? 2 : 0);

  legendItems.append("text")
    .attr("x", 32)
    .attr("y", 12)
    .attr("fill", "rgba(255,255,255,0.8)")
    .attr("font-size", "11px")
    .attr("dy", "0.35em")
    .text(d => d);

  legendItems.append("text")
    .attr("class", "side-indicator")
    .attr("x", 32)
    .attr("y", 28)
    .attr("fill", "rgba(255,255,255,0.5)")
    .attr("font-size", "9px")
    .attr("font-weight", "600")
    .text(d => d === leftGroup ? "‚óÄ LEFT" : d === rightGroup ? "RIGHT ‚ñ∂" : "");
});

/* ============================================================
   3. MEDICAL NETWORK (FORCE-DIRECTED ‚Äì Enhanced Dark Theme)
============================================================ */
d3.json("data/medical_network.json").then(graph => {
  const svg = d3.select("#network"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

  // Enhanced color scheme
  const color = d3.scaleOrdinal()
    .domain(["symptom", "disease", "medication", "risk", "diagnostic", "procedure"])
    .range(["#34d399", "#f472b6", "#60a5fa", "#fbbf24", "#fb923c", "#a78bfa"]);

  const simulation = d3.forceSimulation(graph.nodes)
    .force("link", d3.forceLink(graph.links).id(d => d.id).distance(130))
    .force("charge", d3.forceManyBody().strength(-500))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collision", d3.forceCollide().radius(d => 25 + Math.sqrt(d.count || 1) * 5));

  // Draw links with gradient colors
  const link = svg.append("g")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line")
    .attr("stroke", d => {
      const sourceNode = graph.nodes.find(n => n.id === d.source.id || n.id === d.source);
      return sourceNode ? color(sourceNode.group) : "#666";
    })
    .attr("stroke-opacity", 0.4)
    .attr("stroke-width", 2);

  // Create node groups
  const nodeGroup = svg.append("g")
    .selectAll("g")
    .data(graph.nodes)
    .enter().append("g")
    .style("cursor", "pointer")
    .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended)
    );

  // Draw node circles with glow effect
  nodeGroup.append("circle")
    .attr("r", d => 18 + Math.sqrt(d.count || 1) * 4)
    .attr("fill", d => color(d.group))
    .attr("stroke", "rgba(255,255,255,0.3)")
    .attr("stroke-width", 2)
    .style("filter", "drop-shadow(0 0 8px rgba(0,0,0,0.4))");

  // Add node labels
  nodeGroup.append("text")
    .attr("class", "node-label")
    .attr("dy", d => 25 + Math.sqrt(d.count || 1) * 4 + 10)
    .text(d => d.id);

  // Enhanced Tooltip
  const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

  nodeGroup
    .on("mouseover", function(event, d) {
      d3.select(this).select("circle")
        .transition()
        .duration(200)
        .attr("stroke-width", 4)
        .attr("stroke", "#fff");

      tooltip.transition()
        .duration(200)
        .style("opacity", 1);
      tooltip.html(`
        <strong style="color: ${color(d.group)}">${d.id}</strong><br/>
        <span style="color: rgba(255,255,255,0.6)">Category:</span> ${d.group}<br/>
        <span style="color: rgba(255,255,255,0.6)">Connections:</span> ${d.count || 1}
      `)
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY - 30) + "px");
      
      // Highlight connected nodes
      link.style("stroke-opacity", l => 
        (l.source.id === d.id || l.target.id === d.id) ? 0.9 : 0.05
      ).style("stroke-width", l =>
        (l.source.id === d.id || l.target.id === d.id) ? 3 : 1
      );

      nodeGroup.style("opacity", n => {
        const isConnected = graph.links.some(l => 
          (l.source.id === d.id && l.target.id === n.id) ||
          (l.target.id === d.id && l.source.id === n.id) ||
          n.id === d.id
        );
        return isConnected ? 1 : 0.2;
      });
    })
    .on("mouseout", function() {
      d3.select(this).select("circle")
        .transition()
        .duration(200)
        .attr("stroke-width", 2)
        .attr("stroke", "rgba(255,255,255,0.3)");

      tooltip.transition()
        .duration(500)
        .style("opacity", 0);
      link.style("stroke-opacity", 0.4).style("stroke-width", 2);
      nodeGroup.style("opacity", 1);
    });

  simulation.on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

    nodeGroup
      .attr("transform", d => `translate(${d.x},${d.y})`);
  });

  function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }
  function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }

  // Enhanced Network Legend
  const legendData = [
    {group: "symptom", label: "Symptoms"},
    {group: "disease", label: "Diseases"},
    {group: "medication", label: "Medications"},
    {group: "risk", label: "Risk Factors"},
    {group: "diagnostic", label: "Diagnostics"},
    {group: "procedure", label: "Procedures"}
  ];

  const networkLegend = svg.append("g")
    .attr("transform", `translate(${width - 150}, 25)`);

  networkLegend.append("rect")
    .attr("x", -15)
    .attr("y", -10)
    .attr("width", 140)
    .attr("height", legendData.length * 26 + 20)
    .attr("fill", "rgba(255,255,255,0.05)")
    .attr("rx", 10)
    .attr("stroke", "rgba(255,255,255,0.1)");

  legendData.forEach((item, i) => {
    const row = networkLegend.append("g")
      .attr("transform", `translate(0, ${i * 26 + 8})`);
    
    row.append("circle")
      .attr("r", 8)
      .attr("fill", color(item.group));
    
    row.append("text")
      .attr("x", 18)
      .attr("y", 4)
      .attr("fill", "rgba(255,255,255,0.8)")
      .attr("font-size", "12px")
      .text(item.label);
  });
});
</script>

</body>
</html>
